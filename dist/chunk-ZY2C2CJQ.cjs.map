{"version":3,"sources":["/Users/robertpop/work/personal/openclaw-memory/dist/chunk-ZY2C2CJQ.cjs","../src/config/index.ts","../src/core/errors.ts","../src/config/defaults.ts"],"names":[],"mappings":"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;AACT,EAAA;AACI,EAAA;AACK,IAAA;AACT,EAAA;AAGM,EAAA;AAGA,EAAA;AAGF,EAAA;AACA,EAAA;AACF,IAAA;AACO,MAAA;AACL,MAAA;AACA,MAAA;AACF,IAAA;AACF,EAAA;AAEI,EAAA;AACA,EAAA;AACG,IAAA;AACH,MAAA;AACF,IAAA;AACM,IAAA;AACJ,MAAA;AACA,MAAA;AACA,MAAA;AACA,MAAA;AACA,MAAA;AACA,MAAA;AACF,IAAA;AACF,EAAA;AAEI,EAAA;AACA,EAAA;AACF,IAAA;AACE,MAAA;AACA,MAAA;AACA,MAAA;AACA,MAAA;AACF,IAAA;AACF,EAAA;AAEI,EAAA;AACA,EAAA;AACF,IAAA;AACE,MAAA;AACA,MAAA;AACA,MAAA;AACA,MAAA;AACF,IAAA;AACF,EAAA;AAEO,EAAA;AACL,IAAA;AACM,IAAA;AACA,IAAA;AACA,IAAA;AACJ,MAAA;AACA,MAAA;AACF,IAAA;AACA,IAAA;AACA,IAAA;AACA,IAAA;AACA,IAAA;AACA,IAAA;AACA,IAAA;AACF,EAAA;AACF;AAIgB;AACP,EAAA;AACT;AAIgB;AACR,EAAA;AACJ,IAAA;AACA,IAAA;AACA,IAAA;AACA,IAAA;AACA,IAAA;AACF,EAAA;AAEI,EAAA;AACI,IAAA;AACR,EAAA;AACI,EAAA;AACI,IAAA;AACR,EAAA;AACI,EAAA;AACI,IAAA;AACR,EAAA;AACI,EAAA;AACI,IAAA;AACR,EAAA;AAEO,EAAA;AACT;ADZW;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"/Users/robertpop/work/personal/openclaw-memory/dist/chunk-ZY2C2CJQ.cjs","sourcesContent":[null,"import path from \"node:path\";\nimport os from \"node:os\";\nimport fs from \"node:fs\";\nimport type { Tier } from \"../core/types.js\";\nimport { ConfigError } from \"../core/errors.js\";\nimport { DEFAULTS } from \"./defaults.js\";\nimport type { Config, ResolvedConfig, QdrantConfig, AgeConfig, EmbeddingConfig, ExtractionConfig } from \"./schema.js\";\n\nexport type { Config, ResolvedConfig } from \"./schema.js\";\n\n// ── Helper: expand ~ to home dir ────────────────────────────────────────\n\nfunction expandHome(p: string): string {\n  if (p.startsWith(\"~/\") || p === \"~\") {\n    return path.join(os.homedir(), p.slice(1));\n  }\n  return p;\n}\n\n// ── Data Directory ──────────────────────────────────────────────────────\n\nexport function getDataDir(): string {\n  return process.env.OPENCLAW_MEMORY_DATA_DIR || path.join(os.homedir(), \".openclaw-memory\");\n}\n\nexport function getDefaultSqlitePath(): string {\n  return path.join(getDataDir(), \"memory.sqlite\");\n}\n\nexport function getPidFilePath(): string {\n  return path.join(getDataDir(), \"server.pid\");\n}\n\n// ── Config File Discovery ───────────────────────────────────────────────\n\nfunction getConfigSearchPaths(cwd: string): string[] {\n  return [\n    path.join(cwd, \"openclaw-memory.config.ts\"),\n    path.join(cwd, \"openclaw-memory.config.js\"),\n    path.join(cwd, \"openclaw-memory.config.json\"),\n    path.join(getDataDir(), \"config.ts\"),\n    path.join(getDataDir(), \"config.json\"),\n  ];\n}\n\nasync function loadConfigFile(configPath?: string): Promise<Config | null> {\n  const searchPaths = configPath ? [configPath] : getConfigSearchPaths(process.cwd());\n\n  for (const p of searchPaths) {\n    if (fs.existsSync(p)) {\n      if (p.endsWith(\".json\")) {\n        const content = fs.readFileSync(p, \"utf-8\");\n        return JSON.parse(content) as Config;\n      }\n      // For .ts and .js files, try dynamic import\n      try {\n        const mod = await import(p);\n        return (mod.default || mod) as Config;\n      } catch {\n        // Can't import .ts outside of Bun — skip\n      }\n    }\n  }\n\n  return null;\n}\n\n// ── Environment Variable Loading ────────────────────────────────────────\n\nfunction loadFromEnv(): Partial<Config> {\n  const config: Partial<Config> = {};\n\n  // Load .env file if dotenv is available\n  try {\n    const dotenvPath = path.join(process.cwd(), \".env\");\n    if (fs.existsSync(dotenvPath)) {\n      const envContent = fs.readFileSync(dotenvPath, \"utf-8\");\n      for (const line of envContent.split(\"\\n\")) {\n        const trimmed = line.trim();\n        if (!trimmed || trimmed.startsWith(\"#\")) continue;\n        const eqIdx = trimmed.indexOf(\"=\");\n        if (eqIdx === -1) continue;\n        const key = trimmed.slice(0, eqIdx).trim();\n        const value = trimmed.slice(eqIdx + 1).trim().replace(/^[\"']|[\"']$/g, \"\");\n        if (!process.env[key]) {\n          process.env[key] = value;\n        }\n      }\n    }\n  } catch {\n    // No .env file — that's fine\n  }\n\n  const env = process.env;\n\n  // Tier\n  const tier = env.OPENCLAW_MEMORY_TIER || env.MEMORY_TIER;\n  if (tier && [\"lite\", \"standard\", \"full\"].includes(tier)) {\n    config.tier = tier as Tier;\n  }\n\n  // Port/Host\n  const port = env.OPENCLAW_MEMORY_PORT || env.PORT;\n  if (port) config.port = parseInt(port, 10);\n\n  const host = env.OPENCLAW_MEMORY_HOST;\n  if (host) config.host = host;\n\n  // Auth\n  const authToken = env.OPENCLAW_MEMORY_AUTH__TOKEN || env.AUTH_TOKEN || env.MEMORY_TOKEN;\n  if (authToken) {\n    config.auth = { token: authToken, enabled: true };\n  }\n\n  // SQLite\n  const sqlitePath = env.OPENCLAW_MEMORY_SQLITE__PATH || env.SQLITE_PATH;\n  if (sqlitePath) {\n    config.sqlite = { path: sqlitePath };\n  }\n\n  // Qdrant\n  const qdrantUrl = env.OPENCLAW_MEMORY_QDRANT__URL || env.QDRANT_URL;\n  if (qdrantUrl) {\n    config.qdrant = {\n      url: qdrantUrl,\n      collection: env.OPENCLAW_MEMORY_QDRANT__COLLECTION || env.QDRANT_COLLECTION || DEFAULTS.qdrant.collection,\n      apiKey: env.OPENCLAW_MEMORY_QDRANT__API_KEY,\n    };\n  }\n\n  // AGE\n  const ageHost = env.OPENCLAW_MEMORY_AGE__HOST || env.PGHOST;\n  if (ageHost) {\n    config.age = {\n      host: ageHost,\n      port: parseInt(env.OPENCLAW_MEMORY_AGE__PORT || env.PGPORT || String(DEFAULTS.age.port), 10),\n      user: env.OPENCLAW_MEMORY_AGE__USER || env.PGUSER || \"\",\n      password: env.OPENCLAW_MEMORY_AGE__PASSWORD || env.PGPASSWORD || \"\",\n      database: env.OPENCLAW_MEMORY_AGE__DATABASE || env.PGDATABASE || \"\",\n      graph: env.OPENCLAW_MEMORY_AGE__GRAPH || env.AGE_GRAPH || DEFAULTS.age.graph,\n    };\n  }\n\n  // Embedding\n  const embeddingApiKey = env.OPENCLAW_MEMORY_EMBEDDING__API_KEY || env.OPENROUTER_API_KEY || env.OPENAI_API_KEY;\n  if (embeddingApiKey) {\n    config.embedding = {\n      apiKey: embeddingApiKey,\n      baseUrl: env.OPENCLAW_MEMORY_EMBEDDING__BASE_URL || env.EMBEDDING_BASE_URL,\n      model: env.OPENCLAW_MEMORY_EMBEDDING__MODEL || env.EMBEDDING_MODEL || DEFAULTS.embedding.model,\n      dimensions: parseInt(env.OPENCLAW_MEMORY_EMBEDDING__DIMENSIONS || String(DEFAULTS.embedding.dimensions), 10),\n    };\n  }\n\n  // Extraction\n  const extractionApiKey = env.OPENCLAW_MEMORY_EXTRACTION__API_KEY || env.OPENROUTER_API_KEY || env.OPENAI_API_KEY;\n  if (extractionApiKey) {\n    config.extraction = {\n      apiKey: extractionApiKey,\n      baseUrl: env.OPENCLAW_MEMORY_EXTRACTION__BASE_URL || env.EXTRACTION_BASE_URL,\n      model: env.OPENCLAW_MEMORY_EXTRACTION__MODEL || env.EXTRACTION_MODEL || DEFAULTS.extraction.model,\n      enabled: env.OPENCLAW_MEMORY_EXTRACTION__ENABLED !== \"false\",\n    };\n  }\n\n  return config;\n}\n\n// ── Tier Inference ──────────────────────────────────────────────────────\n\nfunction inferTier(config: Partial<Config>): Tier {\n  if (config.tier) return config.tier;\n  if (config.qdrant && config.age) return \"full\";\n  if (config.qdrant) return \"standard\";\n  return \"lite\";\n}\n\n// ── Config Resolution ───────────────────────────────────────────────────\n\nexport async function loadConfig(configPath?: string): Promise<ResolvedConfig> {\n  // 1. Load from file\n  const fileConfig = await loadConfigFile(configPath);\n\n  // 2. Load from env\n  const envConfig = loadFromEnv();\n\n  // 3. Merge: file < env (env wins)\n  const merged: Partial<Config> = {\n    ...fileConfig,\n    ...envConfig,\n    // Deep merge nested objects\n    auth: { ...fileConfig?.auth, ...envConfig.auth },\n    sqlite: { ...fileConfig?.sqlite, ...envConfig.sqlite },\n  };\n\n  if (envConfig.qdrant || fileConfig?.qdrant) {\n    merged.qdrant = { ...fileConfig?.qdrant, ...envConfig.qdrant } as Config[\"qdrant\"];\n  }\n  if (envConfig.age || fileConfig?.age) {\n    merged.age = { ...fileConfig?.age, ...envConfig.age } as Config[\"age\"];\n  }\n  if (envConfig.embedding || fileConfig?.embedding) {\n    merged.embedding = { ...fileConfig?.embedding, ...envConfig.embedding } as Config[\"embedding\"];\n  }\n  if (envConfig.extraction || fileConfig?.extraction) {\n    merged.extraction = { ...fileConfig?.extraction, ...envConfig.extraction } as Config[\"extraction\"];\n  }\n\n  // 4. Infer tier\n  const tier = inferTier(merged);\n\n  // 5. Resolve defaults\n  const sqlitePath = expandHome(merged.sqlite?.path || DEFAULTS.sqlite.path);\n\n  // 6. Resolve optional layers based on tier\n  let qdrant: QdrantConfig | null = null;\n  if (tier !== \"lite\" && merged.qdrant?.url) {\n    qdrant = {\n      url: merged.qdrant.url,\n      collection: merged.qdrant.collection || DEFAULTS.qdrant.collection,\n      apiKey: merged.qdrant.apiKey,\n    };\n  }\n\n  let age: AgeConfig | null = null;\n  if (tier === \"full\" && merged.age?.host) {\n    if (!merged.age.user || !merged.age.password || !merged.age.database) {\n      throw new ConfigError(\"Full tier requires age.user, age.password, and age.database\");\n    }\n    age = {\n      host: merged.age.host,\n      port: merged.age.port || DEFAULTS.age.port,\n      user: merged.age.user,\n      password: merged.age.password,\n      database: merged.age.database,\n      graph: merged.age.graph || DEFAULTS.age.graph,\n    };\n  }\n\n  let embedding: EmbeddingConfig | null = null;\n  if (tier !== \"lite\" && merged.embedding?.apiKey) {\n    embedding = {\n      apiKey: merged.embedding.apiKey,\n      baseUrl: merged.embedding.baseUrl,\n      model: merged.embedding.model || DEFAULTS.embedding.model,\n      dimensions: merged.embedding.dimensions || DEFAULTS.embedding.dimensions,\n    };\n  }\n\n  let extraction: ExtractionConfig | null = null;\n  if (tier !== \"lite\" && merged.extraction?.apiKey) {\n    extraction = {\n      apiKey: merged.extraction.apiKey,\n      baseUrl: merged.extraction.baseUrl,\n      model: merged.extraction.model || DEFAULTS.extraction.model,\n      enabled: merged.extraction.enabled ?? DEFAULTS.extraction.enabled,\n    };\n  }\n\n  return {\n    tier,\n    port: merged.port || DEFAULTS.port,\n    host: merged.host || DEFAULTS.host,\n    auth: {\n      token: merged.auth?.token,\n      enabled: merged.auth?.enabled ?? DEFAULTS.auth.enabled,\n    },\n    sqlite: { path: sqlitePath },\n    qdrant,\n    age,\n    embedding,\n    extraction,\n    agents: merged.agents || fileConfig?.agents || [],\n  };\n}\n\n// ── defineConfig helper for config files ────────────────────────────────\n\nexport function defineConfig(config: Config): Config {\n  return config;\n}\n\n// ── Config summary (redacted) for logging ───────────────────────────────\n\nexport function configSummary(config: ResolvedConfig): string {\n  const lines: string[] = [\n    `Tier: ${config.tier}`,\n    `Port: ${config.port}`,\n    `Host: ${config.host}`,\n    `SQLite: ${config.sqlite.path}`,\n    `Auth: ${config.auth.enabled ? \"enabled\" : \"disabled\"}`,\n  ];\n\n  if (config.qdrant) {\n    lines.push(`Qdrant: ${config.qdrant.url} (collection: ${config.qdrant.collection})`);\n  }\n  if (config.age) {\n    lines.push(`AGE: ${config.age.host}:${config.age.port}/${config.age.database}`);\n  }\n  if (config.embedding) {\n    lines.push(`Embedding: ${config.embedding.model}${config.embedding.baseUrl ? ` via ${config.embedding.baseUrl}` : \"\"}`);\n  }\n  if (config.extraction) {\n    lines.push(`Extraction: ${config.extraction.model}${config.extraction.enabled ? \"\" : \" (disabled)\"}`);\n  }\n\n  return lines.join(\"\\n\");\n}\n","// ── Custom Error Classes ────────────────────────────────────────────────\n\nexport class MemoryError extends Error {\n  constructor(message: string, public readonly code: string) {\n    super(message);\n    this.name = \"MemoryError\";\n  }\n}\n\nexport class ConfigError extends MemoryError {\n  constructor(message: string) {\n    super(message, \"CONFIG_ERROR\");\n    this.name = \"ConfigError\";\n  }\n}\n\nexport class StorageError extends MemoryError {\n  constructor(message: string, public readonly layer: \"sqlite\" | \"qdrant\" | \"age\") {\n    super(message, \"STORAGE_ERROR\");\n    this.name = \"StorageError\";\n  }\n}\n\nexport class ValidationError extends MemoryError {\n  constructor(message: string, public readonly details?: unknown) {\n    super(message, \"VALIDATION_ERROR\");\n    this.name = \"ValidationError\";\n  }\n}\n\nexport class NotFoundError extends MemoryError {\n  constructor(resource: string, id: string) {\n    super(`${resource} not found: ${id}`, \"NOT_FOUND\");\n    this.name = \"NotFoundError\";\n  }\n}\n\nexport class AuthError extends MemoryError {\n  constructor(message: string = \"Unauthorized\") {\n    super(message, \"AUTH_ERROR\");\n    this.name = \"AuthError\";\n  }\n}\n","// ── Default Configuration Values ────────────────────────────────────────\n\nexport const DEFAULTS = {\n  port: 7777,\n  host: \"0.0.0.0\",\n  sqlite: {\n    path: \"~/.openclaw-memory/memory.sqlite\",\n  },\n  qdrant: {\n    collection: \"openclaw_memories\",\n  },\n  age: {\n    port: 5432,\n    graph: \"agent_memory\",\n  },\n  embedding: {\n    model: \"text-embedding-3-small\",\n    dimensions: 1536,\n  },\n  extraction: {\n    model: \"gpt-4o-mini\",\n    enabled: true,\n  },\n  auth: {\n    enabled: true,\n  },\n} as const;\n"]}