{"version":3,"sources":["/Users/robertpop/work/personal/openclaw-memory/dist/chunk-VXULEX3A.cjs","../src/core/memory-service.ts"],"names":[],"mappings":"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","file":"/Users/robertpop/work/personal/openclaw-memory/dist/chunk-VXULEX3A.cjs","sourcesContent":[null,"import { loadConfig, type Config, type ResolvedConfig } from \"../config/index.js\";\nimport { StorageOrchestrator } from \"../storage/orchestrator.js\";\nimport { SearchEngine } from \"../search/engine.js\";\nimport type {\n  Tier,\n  Memory,\n  StoreParams,\n  StoreResult,\n  SearchParams,\n  UpdateParams,\n  ListParams,\n  SearchResponse,\n  HealthResponse,\n  ConversationLogEntry,\n  SummarizeResponse,\n  CreateMemoryRequest,\n} from \"./types.js\";\nimport { ConversationSummarizer } from \"../extraction/summarizer.js\";\n\n// ── MemoryService — Programmatic API ────────────────────────────────────\n\nexport class MemoryService {\n  private orchestrator!: StorageOrchestrator;\n  private searchEngine!: SearchEngine;\n  private summarizer: ConversationSummarizer | null = null;\n  private config!: ResolvedConfig;\n  private initialized = false;\n\n  private pendingConfig: Config | string | undefined;\n\n  constructor(config?: Config | string) {\n    this.pendingConfig = config;\n  }\n\n  async init(): Promise<void> {\n    if (this.initialized) return;\n\n    // Resolve config\n    if (typeof this.pendingConfig === \"string\") {\n      this.config = await loadConfig(this.pendingConfig);\n    } else if (this.pendingConfig) {\n      this.config = await loadConfig();\n      // Override with passed config (simplified — in production you'd deep merge)\n      if (this.pendingConfig.tier) this.config.tier = this.pendingConfig.tier;\n      if (this.pendingConfig.port) this.config.port = this.pendingConfig.port;\n    } else {\n      this.config = await loadConfig();\n    }\n\n    // Initialize orchestrator\n    this.orchestrator = new StorageOrchestrator(this.config);\n    await this.orchestrator.init();\n\n    // Initialize search engine\n    this.searchEngine = new SearchEngine(this.orchestrator);\n\n    // Initialize summarizer if extraction config available\n    if (this.config.extraction) {\n      this.summarizer = new ConversationSummarizer({\n        apiKey: this.config.extraction.apiKey,\n        baseUrl: this.config.extraction.baseUrl,\n        model: this.config.extraction.model,\n      });\n    }\n\n    this.initialized = true;\n  }\n\n  async close(): Promise<void> {\n    if (!this.initialized) return;\n    await this.orchestrator.close();\n    this.initialized = false;\n  }\n\n  // ── Memory CRUD ─────────────────────────────────────────────────────\n\n  async store(params: StoreParams): Promise<StoreResult> {\n    this.ensureInit();\n    const result = await this.orchestrator.createMemory({\n      agent_id: params.agentId,\n      scope: params.scope,\n      subject_id: params.subjectId ?? null,\n      content: params.content,\n      tags: params.tags,\n      source: params.source,\n      created_by: params.createdBy ?? null,\n      extract_entities: params.extractEntities,\n      expires_at: params.expiresAt ?? null,\n    });\n\n    return {\n      id: result.id,\n      agentId: result.agent_id,\n      scope: result.scope,\n      content: result.content,\n      entities: result.entities,\n      createdAt: result.created_at,\n      syncStatus: result.sync_status,\n    };\n  }\n\n  async get(id: string): Promise<Memory | null> {\n    this.ensureInit();\n    return this.orchestrator.sqlite.getMemory(id);\n  }\n\n  async update(id: string, params: UpdateParams): Promise<Memory | null> {\n    this.ensureInit();\n    const result = await this.orchestrator.updateMemory(id, {\n      content: params.content,\n      tags: params.tags,\n      scope: params.scope,\n      subject_id: params.subjectId,\n      expires_at: params.expiresAt,\n      extract_entities: params.extractEntities,\n    });\n    if (!result) return null;\n    return this.orchestrator.sqlite.getMemory(id);\n  }\n\n  async delete(id: string): Promise<boolean> {\n    this.ensureInit();\n    return this.orchestrator.deleteMemory(id);\n  }\n\n  async list(params?: ListParams): Promise<Memory[]> {\n    this.ensureInit();\n    return this.orchestrator.sqlite.listMemories({\n      agent_id: params?.agentId,\n      scope: params?.scope,\n      subject_id: params?.subjectId,\n      source: params?.source,\n      tags: params?.tags,\n      limit: params?.limit,\n      offset: params?.offset,\n      order: params?.order,\n    });\n  }\n\n  // ── Search ──────────────────────────────────────────────────────────\n\n  async search(params: SearchParams): Promise<SearchResponse> {\n    this.ensureInit();\n    return this.searchEngine.search({\n      agent_id: params.agentId,\n      query: params.query,\n      scopes: params.scopes,\n      subject_id: params.subjectId,\n      limit: params.limit,\n      include_graph: params.includeGraph,\n      cross_agent: params.crossAgent,\n      strategy: params.strategy,\n    });\n  }\n\n  async searchSemantic(params: SearchParams): Promise<SearchResponse> {\n    return this.search({ ...params, strategy: \"semantic\" });\n  }\n\n  async searchFulltext(params: SearchParams): Promise<SearchResponse> {\n    return this.search({ ...params, strategy: \"fulltext\" });\n  }\n\n  async searchGraph(params: SearchParams): Promise<SearchResponse> {\n    return this.search({ ...params, strategy: \"graph\" });\n  }\n\n  // ── Conversations ───────────────────────────────────────────────────\n\n  async logConversation(entry: ConversationLogEntry): Promise<void> {\n    this.ensureInit();\n    this.orchestrator.sqlite.appendConversationLog(entry);\n  }\n\n  async summarizeConversation(params: {\n    agentId: string;\n    sessionId: string;\n    userId: string;\n    channel: string;\n    messages: Array<{ role: \"user\" | \"assistant\" | \"system\"; content: string; timestamp: string }>;\n  }): Promise<SummarizeResponse | null> {\n    this.ensureInit();\n\n    if (!this.summarizer) return null;\n\n    const summary = await this.summarizer.summarize(params.messages);\n    if (!summary) return null;\n\n    const result = await this.orchestrator.createMemory({\n      agent_id: params.agentId,\n      scope: \"session\",\n      subject_id: params.userId,\n      content: summary,\n      tags: [\"conversation_summary\", params.channel, `session:${params.sessionId}`],\n      source: \"conversation_summary\",\n      created_by: params.agentId,\n      extract_entities: true,\n    });\n\n    return {\n      memory_id: result.id,\n      summary,\n      entities_extracted: result.entities,\n      relationships_created: 0,\n    };\n  }\n\n  // ── Entities ────────────────────────────────────────────────────────\n\n  async getEntity(type: string, id: string): Promise<Record<string, unknown> | null> {\n    this.ensureInit();\n    if (!this.orchestrator.age) return null;\n    const result = await this.orchestrator.age.getEntityWithRelationships(type, id);\n    return result.entity;\n  }\n\n  async listEntities(type?: string): Promise<Array<Record<string, unknown>>> {\n    this.ensureInit();\n    if (!this.orchestrator.age) return [];\n    return this.orchestrator.age.listEntities(type);\n  }\n\n  async getRelatedEntities(entityId: string, depth?: number): Promise<Array<Record<string, unknown>>> {\n    this.ensureInit();\n    if (!this.orchestrator.age) return [];\n    const results = await this.orchestrator.age.getRelatedEntities(entityId, depth);\n    return results.map((r) => r.entity);\n  }\n\n  // ── Admin ───────────────────────────────────────────────────────────\n\n  async health(): Promise<HealthResponse> {\n    this.ensureInit();\n    return this.orchestrator.healthCheck();\n  }\n\n  async retrySyncQueue(): Promise<{ processed: number; succeeded: number; failed: number }> {\n    this.ensureInit();\n    return this.orchestrator.retrySyncQueue();\n  }\n\n  async migrateMarkdown(paths: string[], agentId: string): Promise<{\n    migrated: number;\n    errors: string[];\n  }> {\n    this.ensureInit();\n    // Use the admin migration logic through the orchestrator directly\n    const fs = await import(\"node:fs\");\n    const pathLib = await import(\"node:path\");\n    let migrated = 0;\n    const errors: string[] = [];\n\n    for (const filePath of paths) {\n      try {\n        if (!fs.existsSync(filePath)) {\n          errors.push(`File not found: ${filePath}`);\n          continue;\n        }\n        const content = fs.readFileSync(filePath, \"utf-8\");\n        const req: CreateMemoryRequest = {\n          agent_id: agentId,\n          scope: \"global\",\n          content: content.trim(),\n          source: \"migration\",\n          created_by: \"migration\",\n          extract_entities: true,\n        };\n        await this.orchestrator.createMemory(req);\n        migrated++;\n      } catch (error) {\n        errors.push(`${filePath}: ${error instanceof Error ? error.message : String(error)}`);\n      }\n    }\n\n    return { migrated, errors };\n  }\n\n  // ── Config ──────────────────────────────────────────────────────────\n\n  get tier(): Tier {\n    return this.config.tier;\n  }\n\n  get resolvedConfig(): ResolvedConfig {\n    return this.config;\n  }\n\n  // ── Internal: expose orchestrator for server mode ───────────────────\n\n  getOrchestrator(): StorageOrchestrator {\n    this.ensureInit();\n    return this.orchestrator;\n  }\n\n  // ── Helpers ─────────────────────────────────────────────────────────\n\n  private ensureInit(): void {\n    if (!this.initialized) {\n      throw new Error(\"MemoryService not initialized. Call .init() first.\");\n    }\n  }\n}\n"]}